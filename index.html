<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border:1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
        </style>
    </head>
    <!--Basically we want when the html loads up to start the game-->
    <body onload="startGame();">
        <script>
            var myGamePiece; //this is the player
            var myBlaster = []; //this is every laser on the screen (cause you can still fire after shooting one)
            var myObstacles = []; //all viruses on the course
            var myScore; //this is the label
            var Score = 0; //this is the counter to add to the label

            function startGame() { //on call, will create the player, the scoreboard and call the creation of the background
                myGamePiece = new component(30, 30, "red", 10, 120,"immune");
                myScore = new component("30px", "Consolas", "black", 280, 40, "text");
                myGameArea.start();
            }

            var myGameArea = { 
                canvas : document.createElement("canvas"),
                start : function() { //this creates the background, setting the size of the game area, set update interval
                    //this.canvas.width = 480;
                    //this.canvas.height = 270;
                    this.canvas.width = 960;
                    this.canvas.height = 540;
                    this.context = this.canvas.getContext("2d");
                    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                    this.frameNo = 0;
                    this.interval = setInterval(updateGameArea, 20);
                    },
                clear : function() {
                    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                },
                stop : function() {
                    clearInterval(this.interval);
                }
            }

            function component(width, height, color, x, y, type) { //this is the function called for every object so that it can be created
                this.type = type;
                this.width = width;
                this.height = height;
                this.speedX = 0;
                this.speedY = 0;    
                this.x = x;
                this.y = y;
                virus_image = new Image();
                virus_image.src = 'virus.png';
                immune_image = new Image();
                immune_image.src = 'monocyte.png';    
                this.update = function() {
                    ctx = myGameArea.context;
                    if (this.type == "text") {
                        ctx.font = this.width + " " + this.height;
                        ctx.fillStyle = color;
                        ctx.fillText(this.text, this.x, this.y);
                    } else if (this.type == "virus"){ //create obstacle
                        
                        //base_image.onload = function(){
                        //    ctx.drawImage(base_image, this.x, this.y, 20, 20);
                        //}
                        ctx.drawImage(virus_image, this.x, this.y, 40, 40);
                        this.width = 40
                        this.height = 40
                        //ctx.fillRect(this.x, this.y, this.width, this.height);
                    } else if(this.type == "immune"){ //create player
                        ctx.drawImage(immune_image, this.x, this.y, 70, 70);
                        this.width = 70
                        this.height = 70
                    } else if(this.type == "fire"){ //create laser
                        ctx.fillStyle = color;
                        ctx.fillRect(this.x,this.y,60,5);
                        this.width = 60;
                        this.height = 5;
                    }

                    
                }
                this.newPos = function() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.speedX = 0;
                    this.speedY = 0;        
                }
                this.crashWith = function(otherobj) {
                    if (this.type == "fire"){ //will check if laser and obstacle have met
                        var myleft = this.x;
                        var myright = this.x + (this.width);
                        var mytop = this.y;
                        var mybottom = this.y + (this.height);
                        var otherleft = otherobj.x;
                        var otherright = otherobj.x + (otherobj.width)+20;
                        var othertop = otherobj.y;
                        var otherbottom = otherobj.y + (otherobj.height)+20;
                        var crash = true;
                        if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
                            crash = false;
                        }
                    }
                    else { //will check if player and obstacle have met
                        var myleft = this.x;
                        var myright = this.x + (this.width)-20;
                        var mytop = this.y;
                        var mybottom = this.y + (this.height)-20;
                        var otherleft = otherobj.x;
                        var otherright = otherobj.x + (otherobj.width)-20;
                        var othertop = otherobj.y;
                        var otherbottom = otherobj.y + (otherobj.height)-20;
                        var crash = true;
                        if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
                            crash = false;
                        }
                    }
                    
                    return crash;
                }
            }

            function updateGameArea() {
                var x, height, gap, minHeight, maxHeight, minGap, maxGap;
                for (i = 0; i < myObstacles.length; i += 1) {
                    for (m = 0; m < myBlaster.length; m += 1) {
                        if (myBlaster[m].crashWith(myObstacles[i])) { //deletes laser and obstacle that collided
                            myBlaster.splice(m,1);
                            myObstacles.splice(i,1);
                            Score = Score + 1;
                            myScore.text="SCORE: " + String(Score);
                            //console.log(myScore.text);
                            //console.log(myScore.type);  
                            //myScore.update();
                        }
                    }
                    if (myGamePiece.crashWith(myObstacles[i])) { //ends game if player and obstacle collide
                        myGameArea.stop();
                        return;
                    } 
                    
                }
                myGameArea.clear();
                myGameArea.frameNo += 1;
                if (myGameArea.frameNo == 1 || everyinterval(150)) {
                    x = myGameArea.canvas.width;
                    minHeight = 20;
                    maxHeight = 520;
                    minGap = 50;
                    maxGap = 200;
                    number = Math.random()+myGameArea.frameNo*0.001; //difficulty progresses with time
                    //console.log(number);
                    checker = 1;
                    heights = [0];
                    for (i = 0; i < number; i += 1) {
                        height = Math.floor(Math.random()*(maxHeight-minHeight+1)+minHeight); //create a random y coordinate for obstacle within canvas height
                        for (t=0; t < heights.length; t += 1){
                            //console.log(heights[t])
                            //console.log(height)
                            if (Math.abs(heights[t] - height) > 20){ //make sure that there is space between obstacles (can delete)
                                heights.push(height);
                                gap = Math.floor((Math.random()*(maxGap-minGap)*10)+minGap);
                                myObstacles.push(new component(10, height, "green", x, height,"virus"));
                            }
                        }

                    }
                }
                for (i = 0; i < myObstacles.length; i += 1) {
                    myObstacles[i].speedX = -1;
                    myObstacles[i].newPos();
                    myObstacles[i].update();
                }
                for (t = 0; t < myBlaster.length; t+= 1){
                    myBlaster[t].speedX = 1;
                    myBlaster[t].newPos();
                    myBlaster[t].update();
                }
                //myScore.text="SCORE: " + myGameArea.frameNo;
                myScore.update();
                myGamePiece.newPos();    
                myGamePiece.update();
            }

            function everyinterval(n) {
                if ((myGameArea.frameNo / n) % 1 == 0) {return true;}
                return false;
            }

            function moveup() {
                myGamePiece.speedY = -10; 
            }

            function movedown() {
                myGamePiece.speedY = 10; 
            }

            function moveleft() {
                myGamePiece.speedX = -10; 
            }

            function moveright() {
                myGamePiece.speedX = 10; 
            }

            function clearmove() {
                myGamePiece.speedX = 0; 
                myGamePiece.speedY = 0; 
            }

            function fire(){
                myBlaster.push(new component(10,10,"red",myGamePiece.x+50,myGamePiece.y+(myGamePiece.width/2),"fire"));
            }

            document.onkeydown = function (e) {
                switch (e.keyCode) {
                    case 38:
                        // up arrow
                        moveup();
                        break;
                    case 40:
                        movedown();
                        // down arrow
                        break;
                    case 32:
                        fire();
                        //spacebar
                        break;
                }
            };

        //TO-DO
        //Change player to have blaster in hand and make it yourself
        //Make title card
        //Make it so that the stage has a certain time limit to determine when they have reached the end of the stage
        //Create background for stages
        //Make stages slide
        </script>
        <!--<div style="text-align:center;width:480px;">
            <button id="up" onmousedown="moveup()" onmouseup="clearmove()" ontouchstart="moveup()">UP</button><br><br>
            <button id="left" onmousedown="moveleft()" onmouseup="clearmove()" ontouchstart="moveleft()">LEFT</button>
            <button id="right" onmousedown="moveright()" onmouseup="clearmove()" ontouchstart="moveright()">RIGHT</button><br><br>
            <button id="down" onmousedown="movedown()" onmouseup="clearmove()" ontouchstart="movedown()">DOWN</button>
        </div>-->

        <p>You are the lymphocyte (the blue blob on the left). The green things that come on the right are viruses. Your job is to shoot as many of the viruses as possible.</p>
        <p>Use the Up and Down keys to move your player. Press Spacebar to shoot lasers to destroy virus. If you get hit by virus, game over</p>
    </body>
</html>
